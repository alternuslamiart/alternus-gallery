generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  CEO
  ARTIST
  CUSTOMER
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ArtworkStatus {
  PENDING
  APPROVED
  REJECTED
  SOLD
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String?   @map("password_hash")
  role          UserRole  @default(CUSTOMER)
  firstName     String?   @map("first_name")
  lastName      String?   @map("last_name")
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  isActive      Boolean   @default(true) @map("is_active")
  emailVerified Boolean   @default(false) @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  lastLogin     DateTime? @map("last_login")

  stripeCustomerId String? @unique @map("stripe_customer_id")

  artist           Artist?
  orders           Order[]
  reviews          Review[]
  notifications    Notification[]
  sentMessages     Message[]      @relation("SentMessages")
  receivedMessages Message[]      @relation("ReceivedMessages")
  adminActions     AdminAction[]
  addresses        Address[]
  accounts         Account[]
  sessions         Session[]
  following        Follow[]

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Artist {
  id                String            @id @default(uuid())
  userId            String            @unique @map("user_id")
  displayName       String            @map("display_name")
  bio               String?
  country           String?
  city              String?
  profileImage      String?           @map("profile_image")
  coverImage        String?           @map("cover_image")
  portfolioImages   String[]          @map("portfolio_images")
  websiteUrl        String?           @map("website_url")
  instagramUrl      String?           @map("instagram_url")
  twitterUrl        String?           @map("twitter_url")
  linkedinUrl       String?           @map("linkedin_url")
  applicationStatus ApplicationStatus @default(PENDING) @map("application_status")
  appliedDate       DateTime          @default(now()) @map("applied_date")
  approvedDate      DateTime?         @map("approved_date")
  rejectedDate      DateTime?         @map("rejected_date")
  rejectionReason   String?           @map("rejection_reason")
  isActive          Boolean           @default(true) @map("is_active")
  suspensionReason  String?           @map("suspension_reason")
  suspendedAt       DateTime?         @map("suspended_at")
  totalArtworks     Int               @default(0) @map("total_artworks")
  totalSales        Int               @default(0) @map("total_sales")
  totalRevenue      Decimal           @default(0) @map("total_revenue") @db.Decimal(12, 2)
  followerCount     Int               @default(0) @map("follower_count")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  paypalEmail String? @map("paypal_email")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  artworks  Artwork[]
  sales     Sale[]
  followers Follow[]

  @@map("artists")
}

model Artwork {
  id               String        @id @default(uuid())
  artistId         String        @map("artist_id")
  title            String
  description      String?
  price            Decimal       @db.Decimal(10, 2)
  primaryImage     String        @map("primary_image")
  additionalImages String[]      @map("additional_images")
  medium           String?
  style            String?
  category         String?
  dimensions       String?
  width            Decimal?      @db.Decimal(8, 2)
  height           Decimal?      @db.Decimal(8, 2)
  depth            Decimal?      @db.Decimal(8, 2)
  weight           Decimal?      @db.Decimal(8, 2)
  yearCreated      Int?          @map("year_created")
  status           ArtworkStatus @default(APPROVED)
  isAvailable      Boolean       @default(true) @map("is_available")
  isFeatured       Boolean       @default(false) @map("is_featured")
  isPreOrder       Boolean       @default(false) @map("is_pre_order")
  preOrderDate     DateTime?     @map("pre_order_date")
  preOrderDiscount Int?          @map("pre_order_discount")
  approvedBy       String?       @map("approved_by")
  approvedAt       DateTime?     @map("approved_at")
  rejectedAt       DateTime?     @map("rejected_at")
  rejectionReason  String?       @map("rejection_reason")
  views            Int           @default(0)
  likes            Int           @default(0)
  soldCount        Int           @default(0) @map("sold_count")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  artist     Artist      @relation(fields: [artistId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]
  reviews    Review[]
  sales      Sale[]

  @@index([artistId])
  @@index([status])
  @@index([isAvailable])
  @@index([price])
  @@map("artworks")
}

model Order {
  id                  String        @id @default(uuid())
  orderNumber         String        @unique @map("order_number")
  userId              String?       @map("user_id")
  guestEmail          String?       @map("guest_email")
  status              OrderStatus   @default(PENDING)
  subtotal            Decimal       @db.Decimal(10, 2)
  shippingCost        Decimal       @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  tax                 Decimal       @default(0) @db.Decimal(10, 2)
  total               Decimal       @db.Decimal(10, 2)
  currency            String        @default("EUR")
  paymentMethod       String?       @map("payment_method")
  paymentStatus       PaymentStatus @default(PENDING) @map("payment_status")
  stripePaymentIntent String?       @unique @map("stripe_payment_intent")
  paypalOrderId       String?       @unique @map("paypal_order_id")
  shippingAddressId   String?       @map("shipping_address_id")
  billingAddressId    String?       @map("billing_address_id")
  trackingNumber      String?       @map("tracking_number")
  estimatedDelivery   DateTime?     @map("estimated_delivery")
  shippedAt           DateTime?     @map("shipped_at")
  deliveredAt         DateTime?     @map("delivered_at")
  notes               String?
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  user            User?       @relation(fields: [userId], references: [id])
  shippingAddress Address?    @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddress  Address?    @relation("BillingAddress", fields: [billingAddressId], references: [id])
  items           OrderItem[]
  sales           Sale[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  artworkId String  @map("artwork_id")
  quantity  Int     @default(1)
  price     Decimal @db.Decimal(10, 2)
  title     String?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  artwork Artwork @relation(fields: [artworkId], references: [id])

  @@map("order_items")
}

model Sale {
  id                    String        @id @default(uuid())
  transactionId         String        @unique @map("transaction_id")
  orderId               String        @map("order_id")
  artworkId             String        @map("artwork_id")
  artistId              String        @map("artist_id")
  artworkPrice          Decimal       @map("artwork_price") @db.Decimal(10, 2)
  galleryCommissionRate Decimal       @default(40.00) @map("gallery_commission_rate") @db.Decimal(5, 2)
  galleryCommission     Decimal       @map("gallery_commission") @db.Decimal(10, 2)
  artistEarning         Decimal       @map("artist_earning") @db.Decimal(10, 2)
  paymentMethod         String?       @map("payment_method")
  paymentStatus         PaymentStatus @default(PENDING) @map("payment_status")
  paymentDate           DateTime?     @map("payment_date")
  payoutStatus          PayoutStatus  @default(PENDING) @map("payout_status")
  payoutDate            DateTime?     @map("payout_date")
  payoutReference       String?       @map("payout_reference")
  saleDate              DateTime      @default(now()) @map("sale_date")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  order   Order   @relation(fields: [orderId], references: [id])
  artwork Artwork @relation(fields: [artworkId], references: [id])
  artist  Artist  @relation(fields: [artistId], references: [id])

  @@index([orderId])
  @@index([artworkId])
  @@index([artistId])
  @@map("sales")
}

model Address {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  firstName  String   @map("first_name")
  lastName   String   @map("last_name")
  address    String
  city       String
  postalCode String   @map("postal_code")
  country    String
  phone      String?
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user           User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")

  @@map("addresses")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  artworkId String   @map("artwork_id")
  rating    Int
  comment   String?
  helpful   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  artwork Artwork @relation(fields: [artworkId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  type      String
  title     String
  message   String?
  linkUrl   String?   @map("link_url")
  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model Message {
  id              String    @id @default(uuid())
  fromUserId      String    @map("from_user_id")
  toUserId        String    @map("to_user_id")
  subject         String?
  message         String
  isRead          Boolean   @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")
  parentMessageId String?   @map("parent_message_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  fromUser      User      @relation("SentMessages", fields: [fromUserId], references: [id])
  toUser        User      @relation("ReceivedMessages", fields: [toUserId], references: [id])
  parentMessage Message?  @relation("MessageThread", fields: [parentMessageId], references: [id])
  replies       Message[] @relation("MessageThread")

  @@map("messages")
}

model AdminAction {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id")
  actionType String   @map("action_type")
  entityType String?  @map("entity_type")
  entityId   String?  @map("entity_id")
  details    Json?
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id])

  @@map("admin_actions")
}

model Follow {
  id         String   @id @default(uuid())
  followerId String   @map("follower_id")
  artistId   String   @map("artist_id")
  createdAt  DateTime @default(now()) @map("created_at")

  follower User   @relation(fields: [followerId], references: [id], onDelete: Cascade)
  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  @@unique([followerId, artistId])
  @@index([followerId])
  @@index([artistId])
  @@map("follows")
}
